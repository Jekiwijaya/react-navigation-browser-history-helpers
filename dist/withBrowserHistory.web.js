Object.defineProperty(exports,"__esModule",{value:true});var _jsxFileName='es6/withBrowserHistory.web.js';var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target;};var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();exports.default=withBroserHistory;var _react=require('react');var _react2=_interopRequireDefault(_react);var _reducer=require('./reducer');var _reducer2=_interopRequireDefault(_reducer);var _history=require('history');var _reactNavigation=require('react-navigation');var _queryString=require('./utils/queryString');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&(typeof call==="object"||typeof call==="function")?call:self;}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;}function withBroserHistory(Navigator){var Wrapper=function(_Component){_inherits(Wrapper,_Component);function Wrapper(props){_classCallCheck(this,Wrapper);var _this=_possibleConstructorReturn(this,(Wrapper.__proto__||Object.getPrototypeOf(Wrapper)).call(this,props));_this.state={nav:Navigator.router.getStateForAction(_reactNavigation.NavigationActions.init())};_this.currentNavProp=null;_this.setNavFromPath=function(path){var pathWithoutQuery=path.indexOf('?')!==-1?path.slice(0,path.indexOf('?')):path;var qs=path.indexOf('?')!==-1?path.slice(path.indexOf('?')+1):'';var params=(0,_queryString.queryStringToObject)(qs);var action=Navigator.router.getActionForPathAndParams(pathWithoutQuery,params)||_reactNavigation.NavigationActions.init();_this.setState({nav:Navigator.router.getStateForAction(action)});};_this.dispatch=function(action){if(typeof action==='function'){if(_this.props.getState)return action(_this.dispatch,_this.props.getState);return action(_this.dispatch,function(){return _this.state.nav;});}var oldState=_this.state.nav;var _this$props$basePath=_this.props.basePath,basePath=_this$props$basePath===undefined?'/':_this$props$basePath;var newState=_this.reducer(_this.history,oldState,action,basePath);_this.triggerAllSubscribers(_this.subscribers,{type:'action',action:action,state:oldState,lastState:newState});_this.setState({nav:newState});return newState;};_this.addListener=function(eventName,handler){if(eventName!=='action'){return{remove:function remove(){}};}_this.subscribers.add(handler);return{remove:function remove(){_this.subscribers.delete(handler);}};};_this.subscribers=new Set();_this.history=null;_this.reducer=(0,_reducer2.default)(Navigator);return _this;}_createClass(Wrapper,[{key:'cleanPathWithBaseUrl',value:function cleanPathWithBaseUrl(path){var _props$basePath=this.props.basePath,basePath=_props$basePath===undefined?'/':_props$basePath;if(path.startsWith(basePath)){return path.slice(basePath.length);}return path;}},{key:'componentDidMount',value:function componentDidMount(){var _this2=this;var uriPrefix=this.props.uriPrefix;var initialPath=this.cleanPathWithBaseUrl(window.location.href.replace(uriPrefix,''));this.history=(0,_history.createBrowserHistory)();this.setNavFromPath(initialPath);this.history.listen(function(location,action){if(action==="POP"){var pathname=location.pathname,search=location.search;var path=_this2.cleanPathWithBaseUrl(pathname+search);var navigationAction=Navigator.router.getActionForPathAndParams(path);_this2.dispatch(_extends({},navigationAction,{dontPushHistory:true}));}});}},{key:'render',value:function render(){var _this3=this;this.currentNavProp=(0,_reactNavigation.getNavigation)(Navigator.router,this.state.nav,this.dispatch,this.subscribers,function(){},function(){return _this3.currentNavProp;});if(!this.state.nav)return null;return _react2.default.createElement(Navigator,{navigation:this.currentNavProp,__source:{fileName:_jsxFileName,lineNumber:93}});}},{key:'triggerAllSubscribers',value:function triggerAllSubscribers(subscribers,payload){subscribers.forEach(function(subscriber){return subscriber(payload);});}}]);return Wrapper;}(_react.Component);Wrapper.router=Navigator.router;return Wrapper;}